{"version":3,"sources":["../src/index.ts","../src/clerkPlugin.ts","../src/types.ts","../src/withClerkMiddleware.ts","../src/clerkClient.ts","../src/constants.ts","../src/utils.ts","../src/getAuth.ts","../src/errors.ts"],"sourcesContent":["export * from '@clerk/backend';\n\nexport type { ClerkFastifyOptions } from './types';\n\nexport { clerkPlugin } from './clerkPlugin';\nexport { getAuth } from './getAuth';\nexport { clerkClient } from './clerkClient';\n","import type { FastifyInstance, FastifyPluginCallback } from 'fastify';\nimport fp from 'fastify-plugin';\n\nimport type { ClerkFastifyOptions } from './types';\nimport { ALLOWED_HOOKS } from './types';\nimport { withClerkMiddleware } from './withClerkMiddleware';\n\nconst plugin: FastifyPluginCallback<ClerkFastifyOptions> = (\n  instance: FastifyInstance,\n  opts: ClerkFastifyOptions,\n  done,\n) => {\n  instance.decorateRequest('auth', null);\n  // run clerk as a middleware to all scoped routes\n  const hookName = opts.hookName || 'preHandler';\n  if (!ALLOWED_HOOKS.includes(hookName)) {\n    throw new Error(`Unsupported hookName: ${hookName}`);\n  }\n\n  instance.addHook(hookName, withClerkMiddleware(opts));\n\n  done();\n};\n\nexport const clerkPlugin = fp(plugin, {\n  name: '@clerk/fastify',\n  fastify: '5.x',\n});\n","import type { ClerkOptions } from '@clerk/backend';\n\nexport const ALLOWED_HOOKS = ['onRequest', 'preHandler'] as const;\n\nexport type ClerkFastifyOptions = ClerkOptions & {\n  hookName?: (typeof ALLOWED_HOOKS)[number];\n};\n","import { AuthStatus } from '@clerk/backend/internal';\nimport type { FastifyReply, FastifyRequest } from 'fastify';\n\nimport { clerkClient } from './clerkClient';\nimport * as constants from './constants';\nimport type { ClerkFastifyOptions } from './types';\nimport { fastifyRequestToRequest } from './utils';\n\nexport const withClerkMiddleware = (options: ClerkFastifyOptions) => {\n  return async (fastifyRequest: FastifyRequest, reply: FastifyReply) => {\n    const req = fastifyRequestToRequest(fastifyRequest);\n\n    const requestState = await clerkClient.authenticateRequest(req, {\n      ...options,\n      secretKey: options.secretKey || constants.SECRET_KEY,\n      publishableKey: options.publishableKey || constants.PUBLISHABLE_KEY,\n      acceptsToken: 'any',\n    });\n\n    requestState.headers.forEach((value, key) => reply.header(key, value));\n\n    const locationHeader = requestState.headers.get(constants.Headers.Location);\n    if (locationHeader) {\n      return reply.code(307).send();\n    } else if (requestState.status === AuthStatus.Handshake) {\n      throw new Error('Clerk: handshake status without redirect');\n    }\n\n    // @ts-expect-error Inject auth so getAuth can read it\n    fastifyRequest.auth = requestState.toAuth();\n  };\n};\n","import { createClerkClient } from '@clerk/backend';\n\nimport { API_URL, API_VERSION, JWT_KEY, MACHINE_SECRET_KEY, SDK_METADATA, SECRET_KEY } from './constants';\n\nexport const clerkClient = createClerkClient({\n  secretKey: SECRET_KEY,\n  machineSecretKey: MACHINE_SECRET_KEY,\n  apiUrl: API_URL,\n  apiVersion: API_VERSION,\n  jwtKey: JWT_KEY,\n  userAgent: `${PACKAGE_NAME}@${PACKAGE_VERSION}`,\n  sdkMetadata: SDK_METADATA,\n});\n","import { constants } from '@clerk/backend/internal';\nimport { apiUrlFromPublishableKey } from '@clerk/shared/apiUrlFromPublishableKey';\n\nexport const API_VERSION = process.env.CLERK_API_VERSION || 'v1';\nexport const SECRET_KEY = process.env.CLERK_SECRET_KEY || '';\nexport const MACHINE_SECRET_KEY = process.env.CLERK_MACHINE_SECRET_KEY || '';\nexport const PUBLISHABLE_KEY = process.env.CLERK_PUBLISHABLE_KEY || '';\nexport const API_URL = process.env.CLERK_API_URL || apiUrlFromPublishableKey(PUBLISHABLE_KEY);\nexport const JWT_KEY = process.env.CLERK_JWT_KEY || '';\nexport const SDK_METADATA = {\n  name: PACKAGE_NAME,\n  version: PACKAGE_VERSION,\n  environment: process.env.NODE_ENV,\n};\n\nexport const { Cookies, Headers } = constants;\n","import type { FastifyRequest } from 'fastify';\n\nexport const fastifyRequestToRequest = (req: FastifyRequest): Request => {\n  const headers = new Headers(\n    Object.keys(req.headers).reduce((acc, key) => {\n      const value = req.headers[key];\n      if (!value) {\n        return acc;\n      }\n\n      if (typeof value === 'string') {\n        acc.set(key, value);\n      } else {\n        acc.set(key, value.join(','));\n      }\n      return acc;\n    }, new Headers()),\n  );\n\n  // Making some manual tests it seems that FastifyRequest populates the req protocol / hostname\n  // based on the forwarded headers. Nevertheless, we are gonna use a dummy base and the request\n  // will be fixed by the internals of the clerk/backend package\n  const dummyOriginReqUrl = new URL(req.url || '', `${req.protocol}://clerk-dummy`);\n  return new Request(dummyOriginReqUrl, {\n    method: req.method,\n    headers,\n  });\n};\n","import type { AuthOptions, GetAuthFn, SignedInAuthObject, SignedOutAuthObject } from '@clerk/backend/internal';\nimport { getAuthObjectForAcceptedToken } from '@clerk/backend/internal';\nimport type { FastifyRequest } from 'fastify';\n\nimport { pluginRegistrationRequired } from './errors';\n\nexport const getAuth: GetAuthFn<FastifyRequest> = ((req: FastifyRequest, options?: AuthOptions) => {\n  const authReq = req as FastifyRequest & { auth: SignedInAuthObject | SignedOutAuthObject };\n\n  if (!authReq.auth) {\n    throw new Error(pluginRegistrationRequired);\n  }\n\n  return getAuthObjectForAcceptedToken({ authObject: authReq.auth, acceptsToken: options?.acceptsToken });\n}) as GetAuthFn<FastifyRequest>;\n","// https://github.com/clerk/javascript/blob/main/packages/remix/src/errors.ts#L1-L0\nconst createErrorMessage = (msg: string) => {\n  return `ðŸ”’ Clerk: ${msg.trim()}\n\nFor more info, check out the docs: https://clerk.com/docs,\nor come say hi in our discord server: https://clerk.com/discord\n`;\n};\n\nexport const pluginRegistrationRequired =\n  createErrorMessage(`The \"clerkPlugin\" should be registered before using the \"getAuth\".\nExample:\n\nimport { clerkPlugin } from '@clerk/fastify';\n\nconst server: FastifyInstance = Fastify({ logger: true });\nserver.register(clerkPlugin);\n`);\n"],"mappings":"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","names":["import_internal","Headers","Headers","fp","import_internal"]}