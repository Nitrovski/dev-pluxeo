{"version":3,"sources":["../src/webhooks.ts","../src/utils.ts"],"sourcesContent":["/* eslint-disable import/export */\nimport type { VerifyWebhookOptions } from '@clerk/backend/webhooks';\nimport { verifyWebhook as verifyWebhookBase } from '@clerk/backend/webhooks';\nimport type { FastifyRequest } from 'fastify';\n\nimport { fastifyRequestToRequest } from './utils';\n\n// Ordering of exports matter here since\n// we're overriding the base verifyWebhook\nexport * from '@clerk/backend/webhooks';\n\n/**\n * Verifies the authenticity of a webhook request using Svix.\n *\n * @param req - The incoming webhook Fastify Request object\n * @param options - Optional configuration object\n * @param options.signingSecret - Custom signing secret. If not provided, falls back to CLERK_WEBHOOK_SIGNING_SECRET env variable\n * @throws Will throw an error if the webhook signature verification fails\n * @returns A promise that resolves to the verified webhook event data\n *\n * @see {@link https://clerk.com/docs/webhooks/sync-data} to learn more about syncing Clerk data to your application using webhooks\n */\nexport async function verifyWebhook(req: FastifyRequest, options?: VerifyWebhookOptions) {\n  const webRequest = fastifyRequestToRequest(req);\n  // Cloning instead of implementing the body inside fastifyRequestToRequest\n  // to make it more predictable\n  const clonedRequest = new Request(webRequest, {\n    body: JSON.stringify(req.body),\n  });\n  return verifyWebhookBase(clonedRequest, options);\n}\n","import type { FastifyRequest } from 'fastify';\n\nexport const fastifyRequestToRequest = (req: FastifyRequest): Request => {\n  const headers = new Headers(\n    Object.keys(req.headers).reduce((acc, key) => {\n      const value = req.headers[key];\n      if (!value) {\n        return acc;\n      }\n\n      if (typeof value === 'string') {\n        acc.set(key, value);\n      } else {\n        acc.set(key, value.join(','));\n      }\n      return acc;\n    }, new Headers()),\n  );\n\n  // Making some manual tests it seems that FastifyRequest populates the req protocol / hostname\n  // based on the forwarded headers. Nevertheless, we are gonna use a dummy base and the request\n  // will be fixed by the internals of the clerk/backend package\n  const dummyOriginReqUrl = new URL(req.url || '', `${req.protocol}://clerk-dummy`);\n  return new Request(dummyOriginReqUrl, {\n    method: req.method,\n    headers,\n  });\n};\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,sBAAmD;;;ACA5C,IAAM,0BAA0B,CAAC,QAAiC;AACvE,QAAM,UAAU,IAAI;AAAA,IAClB,OAAO,KAAK,IAAI,OAAO,EAAE,OAAO,CAAC,KAAK,QAAQ;AAC5C,YAAM,QAAQ,IAAI,QAAQ,GAAG;AAC7B,UAAI,CAAC,OAAO;AACV,eAAO;AAAA,MACT;AAEA,UAAI,OAAO,UAAU,UAAU;AAC7B,YAAI,IAAI,KAAK,KAAK;AAAA,MACpB,OAAO;AACL,YAAI,IAAI,KAAK,MAAM,KAAK,GAAG,CAAC;AAAA,MAC9B;AACA,aAAO;AAAA,IACT,GAAG,IAAI,QAAQ,CAAC;AAAA,EAClB;AAKA,QAAM,oBAAoB,IAAI,IAAI,IAAI,OAAO,IAAI,GAAG,IAAI,QAAQ,gBAAgB;AAChF,SAAO,IAAI,QAAQ,mBAAmB;AAAA,IACpC,QAAQ,IAAI;AAAA,IACZ;AAAA,EACF,CAAC;AACH;;;ADlBA,6BAAc,oCATd;AAsBA,eAAsB,cAAc,KAAqB,SAAgC;AACvF,QAAM,aAAa,wBAAwB,GAAG;AAG9C,QAAM,gBAAgB,IAAI,QAAQ,YAAY;AAAA,IAC5C,MAAM,KAAK,UAAU,IAAI,IAAI;AAAA,EAC/B,CAAC;AACD,aAAO,gBAAAA,eAAkB,eAAe,OAAO;AACjD;","names":["verifyWebhookBase"]}